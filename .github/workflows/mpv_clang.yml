aname: mpv clang

defaults:
  run:
    shell: bash

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Run custom command before building'
        required: false
        type: string

jobs:
  build_mpv:
    name: Building mpv
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'failure' }}
    strategy:
      fail-fast: false
      matrix:
        bit: [x86_64]
    env:
      BIT: ${{ matrix.bit }}
      # Option B: enforce FFmpeg tag even when src_packages is cached
      FFMPEG_TAG: n8.0.1
    container:
      image: docker://ghcr.io/shinchiro/archlinux:latest
    outputs:
      mpv_ver: ${{ steps.build_mpv_step.outputs.mpv_ver }}

    steps:
      - name: Init variable
        run: |
          if [[ $BIT == "i686" ]]; then
            echo "arch=i686" >> $GITHUB_ENV
          elif [[ $BIT == "x86_64" ]]; then
            echo "arch=x86_64" >> $GITHUB_ENV
          elif [[ $BIT == "x86_64_v3" ]]; then
            echo "arch=x86_64" >> $GITHUB_ENV
            echo "x86_64_level=-v3" >> $GITHUB_ENV
            echo "x86_64_v3_ARCH=-DGCC_ARCH=x86-64-v3" >> $GITHUB_ENV
          elif [[ $BIT == "aarch64" ]]; then
            echo "arch=aarch64" >> $GITHUB_ENV
          fi

      - name: Setup git config
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD

      - uses: actions/checkout@main
        with:
          ref: master

      - name: Loading clang sysroot cache
        uses: actions/cache/restore@main
        with:
          path: clang_root
          key: ${{ secrets.CACHE_VERSION }}-clang_root-${{ github.run_id }}
          restore-keys: |
            ${{ secrets.CACHE_VERSION }}-clang_root

      # ✅ NEW (1/2): put clang_root + rust on PATH the correct way (right after clang_root restore)
      - name: Prepend toolchain PATH (clang_root + rust)
        run: |
          set -euxo pipefail
          echo "$PWD/clang_root/bin" >> "$GITHUB_PATH"
          echo "$PWD/clang_root/install_rustup/.cargo/bin" >> "$GITHUB_PATH"
          echo "RUSTUP_HOME=$PWD/clang_root/install_rustup" >> "$GITHUB_ENV"
          echo "CARGO_HOME=$PWD/clang_root/install_rustup" >> "$GITHUB_ENV"

      # ✅ NEW (2/2): fail fast if clang_root cache is broken (prevents brotli/others failing later)
      - name: Validate clang_root toolchain
        run: |
          set -euxo pipefail
          ls -la clang_root/bin | head
          test -x "$PWD/clang_root/bin/clang"
          test -x "$PWD/clang_root/bin/ld.lld" || true
          "$PWD/clang_root/bin/clang" --version

      - name: Loading repository cache
        uses: actions/cache/restore@main
        with:
          path: src_packages
          key: ${{ secrets.CACHE_VERSION }}-repository-${{ github.run_id }}
          restore-keys: |
            ${{ secrets.CACHE_VERSION }}-repository

      # ✅ Option B goes HERE (after repository cache restore)
      - name: Force FFmpeg tag (n8.0.1)
        run: |
          set -euxo pipefail
          if [ -d src_packages/ffmpeg/.git ]; then
            echo "FFmpeg repo exists — forcing tag ${FFMPEG_TAG}"
            git -C src_packages/ffmpeg fetch --tags --force origin
            git -C src_packages/ffmpeg checkout -f "${FFMPEG_TAG}"
          else
            echo "FFmpeg repo missing — cloning fresh tag ${FFMPEG_TAG}"
            rm -rf src_packages/ffmpeg || true
            git clone --branch "${FFMPEG_TAG}" --depth 1 https://github.com/FFmpeg/FFmpeg.git src_packages/ffmpeg
          fi
          echo "FFmpeg now at:"
          git -C src_packages/ffmpeg describe --tags --always --dirty

      - name: Loading ${{ matrix.bit }} toolchain cache
        uses: actions/cache/restore@main
        with:
          path: build_${{ matrix.bit }}
          key: ${{ secrets.CACHE_VERSION }}-clang-${{ matrix.bit }}_toolchain-${{ github.run_id }}
          restore-keys: |
            ${{ secrets.CACHE_VERSION }}-clang-${{ matrix.bit }}_toolchain

      - name: Toolchain sanity check
        run: |
          set -euxo pipefail
          echo "PATH=$PATH"
          which clang || true
          which ld.lld || true
          clang --version || true
          ld.lld --version || true
          rustc -Vv || true
          cargo -V || true

      - name: Running custom command
        if: ${{ github.event.inputs.command != '' }}
        continue-on-error: true
        run: ${{ github.event.inputs.command }}

      - name: Configuring CMake & Downloading source
        run: |
          set -euxo pipefail
          cmake -DTARGET_ARCH=${{ env.arch }}-w64-mingw32 -DCOMPILER_TOOLCHAIN=clang ${{ env.x86_64_v3_ARCH }} \
            -DCMAKE_INSTALL_PREFIX=$PWD/clang_root \
            -DMINGW_INSTALL_PREFIX=$PWD/build_$BIT/$BIT-w64-mingw32 \
            -DSINGLE_SOURCE_LOCATION=$PWD/src_packages \
            -DRUSTUP_LOCATION=$PWD/clang_root/install_rustup \
            -DENABLE_CCACHE=ON \
            -DCLANG_PACKAGES_LTO=ON \
            -G Ninja --fresh -B build_$BIT -S $PWD
          ninja -C build_$BIT download || true

      - name: Building mpv
        id: build_mpv_step
        run: |
          set -euxo pipefail
          ninja -C build_$BIT update
          ninja -C build_$BIT mpv
          echo "mpv_ver=UNKNOWN" >> $GITHUB_OUTPUT

      - name: Packaging mpv (include dev + debug + release)
        run: |
          set -euxo pipefail
          mkdir -p release_$BIT
          ninja -C build_$BIT mpv-packaging
          mv build_$BIT/mpv*.7z release_$BIT

      - name: Verify libmpv exists
        if: always()
        run: |
          set -euxo pipefail
          ls -la build_$BIT/$BIT-w64-mingw32/bin | grep -i mpv || true
          test -f build_$BIT/$BIT-w64-mingw32/bin/libmpv-2.dll && echo "OK: libmpv-2.dll exists" || echo "WARN: libmpv-2.dll missing"

      - name: Copying ffmpeg
        run: |
          set -euxo pipefail
          hash=$(git -C src_packages/ffmpeg rev-parse --short HEAD)
          7z a -m0=lzma2 -mx=9 -ms=on \
            release_$BIT/ffmpeg-${{ env.arch }}${{ env.x86_64_level }}-git-$hash.7z \
            ./build_$BIT/$BIT-w64-mingw32/bin/ffmpeg.exe

      - name: Collecting logs
        if: always()
        run: |
          set -euxo pipefail
          mkdir -p build_${BIT}_logs
          find build_$BIT -type f \( \
              -iname "*.log" -o -iname "*.txt" -o \
              -name "config.log" -o \
              -name "meson-log.txt" -o \
              -name "CMakeOutput.log" -o -name "CMakeError.log" \
            \) -print0 2>/dev/null | xargs -0 -I{} cp -f --parents "{}" build_${BIT}_logs/ || true
          tar -czf logs.tgz build_${BIT}_logs

      - name: Uploading logs
        uses: actions/upload-artifact@master
        if: always()
        with:
          name: mpv-${{ matrix.bit }}-logs
          path: logs.tgz
          retention-days: 1

      - name: Uploading ${{ matrix.bit }} packages
        uses: actions/upload-artifact@master
        if: always()
        with:
          name: mpv-${{ matrix.bit }}-packages
          path: release_${{ matrix.bit }}/*.7z
          retention-days: 1

      - name: Cleaning build directory
        if: always()
        run: |
          rm -rf build_$BIT/mpv* || true
          rm -rf release_$BIT/mpv-debug*.7z || true

      - name: Cleaning rust toolchain directory
        if: always()
        run: |
          ninja -C build_$BIT cargo-clean || true

      - name: Saving clang sysroot cache
        uses: actions/cache/save@main
        if: ${{ always() && matrix.bit == 'x86_64' }}
        with:
          path: clang_root
          key: ${{ secrets.CACHE_VERSION }}-clang_root-${{ github.run_id }}

      - name: Saving repository cache
        uses: actions/cache/save@main
        if: ${{ always() && matrix.bit == 'x86_64' }}
        with:
          path: src_packages
          key: ${{ secrets.CACHE_VERSION }}-repository-${{ github.run_id }}

      - name: Saving ${{ matrix.bit }} toolchain cache
        uses: actions/cache/save@main
        if: always()
        with:
          path: build_${{ matrix.bit }}
          key: ${{ secrets.CACHE_VERSION }}-clang-${{ matrix.bit }}_toolchain-${{ github.run_id }}

      - name: Saving release_${{ matrix.bit }} cache
        uses: actions/cache/save@main
        if: always()
        with:
          path: release_${{ matrix.bit }}
          key: ${{ secrets.CACHE_VERSION }}-release_${{ matrix.bit }}-${{ github.run_id }}
